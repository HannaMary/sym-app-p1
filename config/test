describe('MaterialItem', () => {
  it('renders all input fields', () => {
    render(<MaterialItem {...defaultProps} />)

    expect(screen.getByLabelText(/transportRequest.handlingUnits.material.serialNumber/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/transportRequest.handlingUnits.material.partNumber/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/transportRequest.handlingUnits.material.description/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/transportRequest.handlingUnits.material.weight/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/transportRequest.handlingUnits.quantity/i)).toBeInTheDocument()
  })

  it('displays error messages for invalid input', () => {
    const propsWithErrors = {
      ...defaultProps,
      errors: {
        handlingUnits: {
          1: {
            materials: {
              0: {
                serialNumber: { type: 'pattern' },
                partNumber: { type: 'pattern' },
                description: { type: 'pattern' },
              },
            },
          },
        },
      },
    }

    render(<MaterialItem {...propsWithErrors} />)
    expect(screen.getByText(/transportRequest.errorQuoteMark/)).toBeInTheDocument()
  })

  it('displays maxLength error for serialNumber', () => {
    const propsWithLengthError = {
      ...defaultProps,
      errors: {
        handlingUnits: {
          1: {
            materials: {
              0: {
                serialNumber: { type: 'maxLength' },
              },
            },
          },
        },
      },
    }

    render(<MaterialItem {...propsWithLengthError} />)
    expect(screen.getByText(/transportRequest.stepOne.errors.maxCharacters/)).toBeInTheDocument()
  })

  it('calls removeMaterial and updateUTMWeightValue on remove button click', () => {
    render(<MaterialItem {...defaultProps} />)

    const removeButton = screen.getByRole('button')
    fireEvent.click(removeButton)

    expect(defaultProps.removeMaterial).toHaveBeenCalledWith(0)
    expect(defaultProps.updateUTMWeightValue).toHaveBeenCalled()
  })
})


it('accepts only number input for weight field and calls updateUTMWeightValue on blur', () => {
  const propsWithWeight = {
    ...defaultProps,
    register: jest.fn(() => ({
      onBlur: defaultProps.updateUTMWeightValue,
      onChange: jest.fn(),
      name: 'handlingUnits.1.materials.0.weight',
      ref: jest.fn(),
    })),
  }

  render(<MaterialItem {...propsWithWeight} />)

  const weightInput = screen.getByLabelText(/transportRequest.handlingUnits.material.weight/i)

  fireEvent.change(weightInput, { target: { value: '42' } })
  fireEvent.blur(weightInput)

  expect(weightInput).toHaveValue(42)
  expect(propsWithWeight.updateUTMWeightValue).toHaveBeenCalled()
})
